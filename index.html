<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laser Tag Hub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 0;
            transition: background 0.3s;
        }
        header {
            background: #333;
            padding: 10px;
            text-align: center;
        }
        nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .button {
            background: #00ffcc;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .button:hover {
            box-shadow: 0 0 15px #00ffcc;
        }
        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        section, .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .hidden {
            display: none;
        }
        input, select, textarea {
            padding: 5px;
            margin: 5px 0;
            width: 100%;
            max-width: 300px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
        }
        #chat-box, #group-chat-box, #message-box, #history-list {
            max-height: 300px;
            overflow-y: auto;
            background: #333;
            padding: 10px;
            border-radius: 5px;
        }
        .achievement {
            background: #444;
            padding: 5px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .achievement-earned {
            background: #00ffcc;
            color: #000;
        }
        .friend-button {
            background: #ff5555;
            padding: 5px 10px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Laser Tag Hub</h1>
        <nav>
            <button id="login-btn" class="button" onclick="showPage('login-form')">Login</button>
            <button id="register-btn" class="button" onclick="showPage('register-form')">Register</button>
            <button id="profile-btn" class="button hidden" onclick="showPage('profile')">Profile</button>
            <button id="play-btn" class="button hidden" onclick="launchRoblox()">Play Now</button>
            <button id="join-friend-btn" class="button hidden" onclick="joinFriend()">Join Friend</button>
            <button id="logout-btn" class="button hidden" onclick="logout()">Logout</button>
            <button id="admin-tools-btn" class="button hidden" onclick="showPage('admin-tools')">Admin Tools</button>
            <button id="friends-btn" class="button hidden" onclick="showPage('friends')">Friends</button>
            <button id="messages-btn" class="button hidden" onclick="showPage('messages')">Messages</button>
            <button id="matchmaking-btn" class="button hidden" onclick="joinMatchmaking()">Matchmaking</button>
            <button id="group-chat-btn" class="button hidden" onclick="showPage('group-chat')">Group Chat</button>
            <button id="settings-btn" class="button" onclick="showPage('settings')">Settings</button>
        </nav>
    </header>
    <main>
        <section id="home">
            <h2>Welcome to Laser Tag!</h2>
            <p>Online Players: <span id="online-players">Loading...</span></p>
            <p>Search for a user:</p>
            <input type="text" id="search-bar" placeholder="Enter username...">
            <button class="button" onclick="searchUsers()">Search</button>
        </section>
        <section id="login-form" class="hidden">
            <h2>Login</h2>
            <input type="text" id="login-username" placeholder="Username">
            <input type="password" id="login-password" placeholder="Password">
            <button class="button" onclick="login()">Login</button>
        </section>
        <section id="register-form" class="hidden">
            <h2>Register</h2>
            <input type="text" id="reg-username" placeholder="Username">
            <input type="password" id="reg-password" placeholder="Password">
            <button class="button" onclick="register()">Register</button>
        </section>
        <section id="profile" class="hidden">
            <h2>Profile</h2>
            <p><span id="user-title">Rookie</span> <span id="user-name"></span> <span id="user-badge"></span></p>
            <p>Bio: <span id="user-bio">No bio set</span></p>
            <p>Games Played: <span id="games-played">0</span></p>
            <p>Kills: <input type="number" id="kills" min="0"></p>
            <p>Deaths: <input type="number" id="deaths" min="0"></p>
            <p>K/D Ratio: <span id="kd-ratio">0</span></p>
            <p>Win Rate: <span id="win-rate">0%</span></p>
            <button class="button" onclick="updateStats()">Update Stats</button>
            <button class="button" onclick="fetchRealStats()">Fetch Game Stats</button>
            <h3>Achievements</h3>
            <div id="achievements"></div>
        </section>
        <section id="admin-tools" class="hidden">
            <h2>Admin Tools</h2>
            <input type="text" id="admin-target" placeholder="Target Username">
            <input type="text" id="ban-reason" placeholder="Ban Reason (optional)">
            <button class="button" onclick="banUser()">Ban User</button>
            <button class="button" onclick="unbanUser()">Unban User</button>
            <button class="button" onclick="makeAdmin()">Make Admin</button>
            <button class="button" onclick="removeAdmin()">Remove Admin</button>
            <button class="button" onclick="resetUserStats()">Reset Stats</button>
            <button class="button" onclick="massBan()">Mass Ban</button>
            <button class="button" onclick="massUnban()">Mass Unban</button>
            <button class="button" onclick="broadcastMessage()">Broadcast</button>
            <button class="button" onclick="clearChat()">Clear Chat</button>
            <h3>Reports</h3>
            <div id="reports"></div>
        </section>
        <section id="friends" class="hidden">
            <h2>Friends</h2>
            <input type="text" id="friend-username" placeholder="Add Friend">
            <button class="button" onclick="addFriend()">Add Friend</button>
            <div id="friend-list"></div>
        </section>
        <section id="messages" class="hidden">
            <h2>Messages</h2>
            <input type="text" id="message-recipient" placeholder="Recipient">
            <input type="text" id="message-input" placeholder="Message">
            <select id="emote-select-message">
                <option value="">Add Emote</option>
                <option value=":smile:">:smile:</option>
                <option value=":fire:">:fire:</option>
                <option value=":thumbsup:">:thumbsup:</option>
                <option value=":heart:">:heart:</option>
                <option value=":laugh:">:laugh:</option>
            </select>
            <button class="button" onclick="addEmote('message-input')">Add</button>
            <button class="button" onclick="sendPrivateMessage()">Send</button>
            <div id="message-box"></div>
        </section>
        <section id="group-chat" class="hidden">
            <h2>Group Chat</h2>
            <input type="text" id="group-chat-name" placeholder="Group Name">
            <select id="group-members" multiple></select>
            <button class="button" onclick="createGroupChat()">Create Group</button>
            <select id="group-chat-select" onchange="switchGroupChat()">
                <option value="">Select a group</option>
            </select>
            <div id="group-chat-box"></div>
            <input type="text" id="group-chat-input" placeholder="Type a message...">
            <select id="emote-select-group">
                <option value="">Add Emote</option>
                <option value=":smile:">:smile:</option>
                <option value=":fire:">:fire:</option>
                <option value=":thumbsup:">:thumbsup:</option>
                <option value=":heart:">:heart:</option>
                <option value=":laugh:">:laugh:</option>
            </select>
            <button class="button" onclick="addEmote('group-chat-input')">Add</button>
            <button class="button" onclick="sendGroupChat()">Send</button>
        </section>
        <section id="settings" class="hidden">
            <h2>Settings</h2>
            <p>Theme:</p>
            <button class="button" onclick="setTheme('dark')">Dark</button>
            <button class="button" onclick="setTheme('light')">Light</button>
            <p>Button Color:</p>
            <input type="color" id="button-color" value="#00ffcc" onchange="setButtonColor()">
            <p>Sound Settings:</p>
            <label><input type="checkbox" id="mute-click" onchange="updateSoundSettings()"> Mute Click</label><br>
            <label><input type="checkbox" id="mute-fanfare" onchange="updateSoundSettings()"> Mute Fanfare</label><br>
            <label><input type="checkbox" id="mute-ambient" onchange="updateSoundSettings()"> Mute Ambient</label><br>
            <label><input type="checkbox" id="mute-music" onchange="toggleMusic()"> Toggle Music</label><br>
            <p>Change Password:</p>
            <input type="password" id="current-password" placeholder="Current Password">
            <input type="password" id="new-password" placeholder="New Password">
            <button class="button" onclick="changePassword()">Change Password</button>
            <p>Set Bio:</p>
            <input type="text" id="bio-input" placeholder="Enter bio (max 50 chars)">
            <button class="button" onclick="setBio()">Set Bio</button>
            <p>Title:</p>
            <select id="title-select" onchange="setTitle()"></select>
            <button class="button" onclick="exportData()">Export Data</button>
        </section>
        <div id="content">
            <div id="leaderboard" class="container hidden">
                <h3>Leaderboard</h3>
                <p>Top Player: <span id="top-player">N/A</span> - <span id="top-score">0</span> Kills</p>
            </div>
            <div id="chat" class="container hidden">
                <h3>Chat</h3>
                <div id="chat-box"></div>
                <input type="text" id="chat-input" placeholder="Type a message...">
                <select id="emote-select-chat">
                    <option value="">Add Emote</option>
                    <option value=":smile:">:smile:</option>
                    <option value=":fire:">:fire:</option>
                    <option value=":thumbsup:">:thumbsup:</option>
                    <option value=":heart:">:heart:</option>
                    <option value=":laugh:">:laugh:</option>
                </select>
                <button class="button" onclick="addEmote('chat-input')">Add</button>
                <button class="button" onclick="sendChat()">Send</button>
            </div>
            <div id="match-history" class="container hidden">
                <h3>Match History</h3>
                <div id="history-list"></div>
            </div>
        </div>
        <div id="banned-notice" class="container hidden">
            <h2>You Are Banned!</h2>
            <p>Reason: <span id="ban-reason"></span></p>
            <button class="button" onclick="logout()">OK</button>
        </div>
    </main>
    <audio id="click-sound" src="https://www.myinstants.com/media/sounds/click.mp3" preload="auto"></audio>
    <audio id="fanfare-sound" src="https://www.myinstants.com/media/sounds/fanfare.mp3" preload="auto"></audio>
    <audio id="ambient-sound" src="https://www.myinstants.com/media/sounds/ambient.mp3" preload="auto" loop></audio>
    <audio id="music" src="https://halaldevsyt.github.io/Laser-Tag/wedding_song.mp3" preload="auto" loop></audio>

    <script>
        console.log("Script starting...");

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM fully loaded");

            // Global variables
            let isLoggedIn = false;
            let currentUser = null;
            let userData = JSON.parse(localStorage.getItem('userData')) || {};
            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            let groupChats = JSON.parse(localStorage.getItem('groupChats')) || {};
            let soundSettings = JSON.parse(localStorage.getItem('soundSettings')) || {
                click: true,
                fanfare: true,
                ambient: true,
                music: true
            };
            let matchmakingQueue = [];
            const teams = { red: [], pink: [], green: [] };
            const teamOrder = ['red', 'pink', 'green'];
            const maxTeamSize = 6;
            const emotes = {
                ":smile:": "😊",
                ":fire:": "🔥",
                ":thumbsup:": "👍",
                ":heart:": "❤️",
                ":laugh:": "😂"
            };
            let matchmakingInterval = null;
            const serverUrl = "https://d82c5016-bcff-40a1-aa09-768942016abd-00-39hwdpipka72n.janeway.replit.dev";

            // Default user setup
            if (!userData['Halaldeveloper']) {
                userData['Halaldeveloper'] = {
                    password: 'HOOKfor9',
                    gamesPlayed: 0,
                    kills: 0,
                    deaths: 0,
                    wins: 0,
                    history: [],
                    friends: [],
                    messages: [],
                    reports: [],
                    bio: '',
                    lastLogin: null,
                    team: null,
                    titles: ["Rookie"],
                    activeTitle: "Rookie",
                    isAdmin: true,
                    isOwner: true,
                    isBanned: false,
                    banReason: ''
                };
                saveUserData();
            }

            // Initial setup
            try {
                currentUser = localStorage.getItem('currentUser');
                isLoggedIn = !!currentUser && !!userData[currentUser] && !userData[currentUser].isBanned;
                console.log("Initial state:", { currentUser, isLoggedIn });

                if (currentUser && userData[currentUser]?.isBanned) {
                    showBannedNotice();
                } else {
                    document.getElementById("mute-click").checked = !soundSettings.click;
                    document.getElementById("mute-fanfare").checked = !soundSettings.fanfare;
                    document.getElementById("mute-ambient").checked = !soundSettings.ambient;
                    document.getElementById("mute-music").checked = !soundSettings.music;
                    if (soundSettings.ambient) document.getElementById("ambient-sound").play().catch(err => console.error("Ambient audio failed:", err));
                    if (soundSettings.music) document.getElementById("music").play().catch(err => console.error("Music (wedding_song.mp3) failed:", err));
                    loadChatHistory();
                    updatePlayerCount();
                    if (isLoggedIn) {
                        updateUI();
                        updateProfile(currentUser);
                        checkDailyReward();
                        populateGroupMembers();
                        populateTitles();
                        showPage('home');
                    }
                }
            } catch (error) {
                console.error("Initialization error:", error);
            }

            window.onbeforeunload = () => {
                if (!userData[currentUser]?.isBanned) {
                    saveUserData();
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    localStorage.setItem('groupChats', JSON.stringify(groupChats));
                    localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
                }
            };

            // Core functions
            function saveUserData() {
                const existingData = JSON.parse(localStorage.getItem('userData')) || {};
                userData = { ...existingData, ...userData };
                localStorage.setItem('userData', JSON.stringify(userData));
                console.log("User data saved");
            }

            function showBannedNotice() {
                document.getElementById("content").classList.add("hidden");
                document.getElementById("banned-notice").classList.remove("hidden");
                document.getElementById("ban-reason").innerText = userData[currentUser]?.banReason || "No reason provided";
                localStorage.removeItem('currentUser');
                isLoggedIn = false;
                currentUser = null;
                console.log("Banned notice shown");
            }

            function updatePlayerCount() {
                fetch(`${serverUrl}/player-count`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById("online-players").innerText = data.playerCount;
                        console.log("Player count updated:", data.playerCount);
                    })
                    .catch(error => {
                        document.getElementById("online-players").innerText = "Error";
                        console.error("Failed to fetch player count:", error);
                    });
                setTimeout(updatePlayerCount, 10000);
            }

            function showPage(page) {
                console.log("Showing page:", page);
                if (userData[currentUser]?.isBanned) {
                    showBannedNotice();
                    return;
                }
                document.querySelectorAll("main section, .container").forEach(section => {
                    section.classList.add("hidden");
                    section.style.opacity = "0";
                });
                const target = document.getElementById(page);
                target.classList.remove("hidden");
                setTimeout(() => target.style.opacity = "1", 10);
                if (isLoggedIn && page === 'home') {
                    ['leaderboard', 'chat', 'match-history'].forEach(id => document.getElementById(id).classList.remove('hidden'));
                } else {
                    ['leaderboard', 'chat', 'match-history'].forEach(id => document.getElementById(id).classList.add('hidden'));
                }
                if (page === 'group-chat' && isLoggedIn) populateGroupMembers();
                if (page === 'settings' && isLoggedIn) populateTitles();
                if (page === 'friends' && isLoggedIn) updateFriendList();
            }

            function login() {
                console.log("Login clicked");
                try {
                    const username = document.getElementById("login-username").value.trim();
                    const password = document.getElementById("login-password").value;
                    if (!username || !password) {
                        alert("Please enter both username and password.");
                        return;
                    }
                    if (userData[username] && userData[username].password === password) {
                        if (userData[username].isBanned) {
                            alert(`You are banned! Reason: ${userData[username].banReason || 'No reason provided'}`);
                            currentUser = username;
                            showBannedNotice();
                            return;
                        }
                        playSound('fanfare');
                        alert("Login successful!");
                        currentUser = username;
                        isLoggedIn = true;
                        localStorage.setItem('currentUser', currentUser);
                        document.getElementById("user-name").innerText = username;
                        updateUI();
                        updateProfile(username);
                        checkDailyReward();
                        showPage('home');
                    } else {
                        alert("Invalid username or password.");
                    }
                } catch (error) {
                    console.error("Login error:", error);
                }
            }

            function register() {
                console.log("Register clicked");
                try {
                    const username = document.getElementById("reg-username").value.trim();
                    const password = document.getElementById("reg-password").value;
                    if (!username || !password) {
                        alert("Please enter both username and password.");
                        return;
                    }
                    if (userData[username]) {
                        alert("Username already taken!");
                    } else if (username.length < 3) {
                        alert("Username must be at least 3 characters long!");
                    } else {
                        userData[username] = {
                            password,
                            gamesPlayed: 0,
                            kills: 0,
                            deaths: 0,
                            wins: 0,
                            history: [],
                            friends: [],
                            messages: [],
                            reports: [],
                            bio: '',
                            lastLogin: null,
                            team: null,
                            titles: ["Rookie"],
                            activeTitle: "Rookie",
                            isAdmin: false,
                            isBanned: false,
                            banReason: ''
                        };
                        saveUserData();
                        playSound('fanfare');
                        alert("Registration successful! Please login.");
                        showPage('login-form');
                    }
                } catch (error) {
                    console.error("Register error:", error);
                }
            }

            function logout() {
                console.log("Logout clicked");
                try {
                    if (userData[currentUser]?.isBanned) {
                        document.getElementById("banned-notice").classList.add("hidden");
                        document.getElementById("content").classList.remove("hidden");
                    } else if (userData[currentUser]?.team) {
                        teams[userData[currentUser].team] = teams[userData[currentUser].team].filter(u => u !== currentUser);
                        userData[currentUser].team = null;
                    }
                    isLoggedIn = false;
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    playSound('click');
                    alert("You have been logged out.");
                    updateUI();
                    showPage('home');
                } catch (error) {
                    console.error("Logout error:", error);
                }
            }

            function updateUI() {
                console.log("Updating UI");
                document.getElementById("login-btn").classList.toggle("hidden", isLoggedIn);
                document.getElementById("register-btn").classList.toggle("hidden", isLoggedIn);
                document.getElementById("profile-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("play-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("join-friend-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("logout-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("admin-tools-btn").classList.toggle("hidden", !isLoggedIn || !userData[currentUser]?.isAdmin);
                document.getElementById("friends-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("messages-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("matchmaking-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("group-chat-btn").classList.toggle("hidden", !isLoggedIn);
                document.getElementById("chat").classList.toggle("hidden", !isLoggedIn);
                setButtonColor();
            }

            function updateProfile(username) {
                console.log("Updating profile:", username);
                if (!username || !userData[username] || userData[username].isBanned) {
                    showBannedNotice();
                    return;
                }
                document.getElementById("user-title").innerText = userData[username].activeTitle || "Rookie";
                document.getElementById("user-name").innerText = username;
                document.getElementById("user-badge").innerText = userData[username].isOwner ? "👑" : userData[username].isAdmin ? "⭐" : "";
                document.getElementById("user-bio").innerText = userData[username].bio || "No bio set";
                document.getElementById("games-played").innerText = userData[username].gamesPlayed || 0;
                document.getElementById("kills").value = userData[username].kills || 0;
                document.getElementById("deaths").value = userData[username].deaths || 0;
                const kd = userData[username].deaths === 0 ? userData[username].kills : (userData[username].kills / userData[username].deaths).toFixed(2);
                document.getElementById("kd-ratio").innerText = kd;
                const winRate = userData[username].gamesPlayed === 0 ? 0 : ((userData[username].wins / userData[username].gamesPlayed) * 100).toFixed(0);
                document.getElementById("win-rate").innerText = `${winRate}%`;
                updateLeaderboard();
                updateAchievements(username);
                updateMatchHistory(username);
                updateFriendList();
                updateMessages();
                updateGroupChatSelect();
                updateReports();
                populateTitles();
                syncLeaderboardAndHistory();
            }

            function updateStats() {
                console.log("Update stats clicked");
                if (!currentUser || !userData[currentUser]) return;
                const username = document.getElementById("user-name").innerText;
                const kills = parseInt(document.getElementById("kills").value) || 0;
                const deaths = parseInt(document.getElementById("deaths").value) || 0;
                if (kills < 0 || deaths < 0) return alert("Stats cannot be negative!");
                userData[username].kills = kills;
                userData[username].deaths = deaths;
                saveUserData();
                updateProfile(username);
            }

            function setTheme(theme) {
                console.log("Setting theme:", theme);
                if (!currentUser || !userData[currentUser]) return;
                document.body.className = '';
                document.body.classList.add(theme === 'light' ? 'light' : 'dark');
                playSound('click');
            }

            function setButtonColor() {
                console.log("Setting button color");
                const color = isLoggedIn && userData[currentUser]?.buttonColor ? userData[currentUser].buttonColor : document.getElementById("button-color").value;
                document.querySelectorAll(".button, .friend-button").forEach(btn => {
                    btn.style.background = color;
                    btn.style.boxShadow = `0 0 10px ${color}`;
                    btn.onmouseover = () => {
                        btn.style.background = darkenColor(color);
                        btn.style.boxShadow = `0 0 20px ${color}`;
                    };
                    btn.onmouseout = () => {
                        btn.style.background = color;
                        btn.style.boxShadow = `0 0 10px ${color}`;
                    };
                });
                if (isLoggedIn) {
                    userData[currentUser].buttonColor = color;
                    saveUserData();
                }
            }

            function darkenColor(hex) {
                let r = parseInt(hex.slice(1, 3), 16) * 0.8;
                let g = parseInt(hex.slice(3, 5), 16) * 0.8;
                let b = parseInt(hex.slice(5, 7), 16) * 0.8;
                return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
            }

            function playSound(type) {
                console.log("Playing sound:", type);
                if (type === 'click' && !soundSettings.click) return;
                if (type === 'fanfare' && !soundSettings.fanfare) return;
                const sound = document.getElementById(type === 'click' ? 'click-sound' : 'fanfare-sound');
                sound.currentTime = 0;
                sound.play().catch(err => console.error("Sound play failed:", err));
            }

            function updateSoundSettings() {
                console.log("Updating sound settings");
                if (!currentUser || !userData[currentUser]) return;
                soundSettings.click = !document.getElementById("mute-click").checked;
                soundSettings.fanfare = !document.getElementById("mute-fanfare").checked;
                soundSettings.ambient = !document.getElementById("mute-ambient").checked;
                soundSettings.music = !document.getElementById("mute-music").checked;
                const ambient = document.getElementById("ambient-sound");
                const music = document.getElementById("music");
                if (soundSettings.ambient) ambient.play().catch(err => console.error("Ambient failed:", err));
                else ambient.pause();
                if (soundSettings.music) music.play().catch(err => console.error("Music failed:", err));
                else music.pause();
                localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
            }

            function toggleMusic() {
                console.log("Toggling music");
                if (!currentUser || !userData[currentUser]) return;
                soundSettings.music = !document.getElementById("mute-music").checked;
                const music = document.getElementById("music");
                if (soundSettings.music) music.play().catch(err => console.error("Music failed:", err));
                else music.pause();
                localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
            }

            function launchRoblox() {
                console.log("Launch Roblox clicked");
                if (!currentUser || !userData[currentUser]) return;
                window.open("https://www.roblox.com/games/109363541562257/Laser-Tag", "_blank");
                userData[currentUser].gamesPlayed = (userData[currentUser].gamesPlayed || 0) + 1;
                const team = assignTeam(currentUser);
                userData[currentUser].history.push(`Played on ${team} team on ${new Date().toLocaleString()}`);
                if (Math.random() < 0.3) userData[currentUser].wins = (userData[currentUser].wins || 0) + 1;
                saveUserData();
                updateProfile(currentUser);
                playSound('fanfare');
                alert(`Launching Laser Tag on ${team} team!`);
            }

            function joinFriend() {
                console.log("Join friend clicked");
                if (!currentUser || !userData[currentUser]) return;
                const friend = prompt("Enter friend's username:").trim();
                if (!friend) return;
                if (userData[friend]) {
                    if (userData[friend].isBanned) {
                        alert(`${friend} is banned and cannot be joined!`);
                        return;
                    }
                    const team = userData[friend].team || assignTeam(currentUser);
                    userData[currentUser].team = team;
                    teams[team].push(currentUser);
                    alert(`Joining ${friend}'s game on ${team} team! (Simulated)`);
                    playSound('fanfare');
                } else {
                    alert("Friend not found!");
                }
            }

            function assignTeam(username) {
                if (!username || !userData[username]) return null;
                if (userData[username].team && teams[userData[username].team].length < maxTeamSize) {
                    return userData[username].team;
                }
                if (userData[username].team) {
                    teams[userData[username].team] = teams[userData[username].team].filter(u => u !== username);
                }
                const team = teamOrder.find(t => teams[t].length < maxTeamSize) || teamOrder[0];
                teams[team].push(username);
                userData[username].team = team;
                saveUserData();
                return team;
            }

            function updateLeaderboard() {
                console.log("Updating leaderboard");
                if (!currentUser || !userData[currentUser]) return;
                let topPlayer = "N/A";
                let topScore = 0;
                for (let user in userData) {
                    if (!userData[user].isBanned && userData[user].kills > topScore) {
                        topScore = userData[user].kills;
                        topPlayer = user;
                    }
                }
                document.getElementById("top-player").innerText = topPlayer;
                document.getElementById("top-score").innerText = topScore;
                syncLeaderboardAndHistory();
            }

            function syncLeaderboardAndHistory() {
                if (!currentUser || !userData[currentUser]) return;
                const leaderboardData = Object.entries(userData).map(([name, data]) => ({
                    name,
                    kills: data.kills,
                    deaths: data.deaths
                }));
                fetch(`${serverUrl}/leaderboard`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(leaderboardData)
                }).catch(err => console.error('Leaderboard sync failed:', err));

                const matchHistoryData = userData[currentUser].history.map(match => ({
                    match: match,
                    timestamp: new Date().toLocaleString()
                }));
                fetch(`${serverUrl}/match-history`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(matchHistoryData)
                }).catch(err => console.error('Match history sync failed:', err));
            }

            function searchUsers() {
                console.log("Search users clicked");
                if (!currentUser || !userData[currentUser]) return;
                const query = document.getElementById("search-bar").value.trim().toLowerCase();
                if (!query) return alert("Please enter a search term.");
                for (let user in userData) {
                    if (user.toLowerCase().includes(query)) {
                        const status = userData[user].isBanned ? ` (Banned: ${userData[user].banReason || 'No reason'})` : userData[user].isAdmin ? " (Admin)" : "";
                        const badge = userData[user].isOwner ? "👑" : userData[user].isAdmin ? "⭐" : "";
                        const title = userData[user].activeTitle || "Rookie";
                        const team = userData[user].team ? `Team: ${userData[user].team}` : "No team";
                        alert(`Found: ${title} ${user}${badge}${status} - Kills: ${userData[user].kills}, Deaths: ${userData[user].deaths}\n${team}\nBio: ${userData[user].bio || 'No bio'}\nReport this user?\nType "yes" to report.`);
                        if (prompt("Report this user? (yes/no)").toLowerCase() === "yes") {
                            reportUser(user);
                        }
                        return;
                    }
                }
                alert("No user found matching your search.");
            }

            function reportUser(target) {
                console.log("Reporting user:", target);
                if (!currentUser || !userData[currentUser]) return;
                userData[target].reports.push({
                    from: currentUser,
                    reason: prompt("Reason for reporting this user:"),
                    time: new Date().toLocaleString()
                });
                saveUserData();
                alert(`${target} has been reported!`);
                updateReports();
            }

            function updateReports() {
                console.log("Updating reports");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return;
                const reportsDiv = document.getElementById("reports");
                let allReports = [];
                for (let user in userData) {
                    if (userData[user].reports.length > 0) {
                        allReports.push(`<p><b>${user}:</b></p>` + userData[user].reports.map(r => `<p>Reported by ${r.from}: ${r.reason} (${r.time})</p>`).join(''));
                    }
                }
                reportsDiv.innerHTML = allReports.length > 0 ? allReports.join('') : "<p>No reports yet.</p>";
            }

            function updateAchievements(username) {
                console.log("Updating achievements for:", username);
                if (!username || !userData[username]) return;
                const achievementsDiv = document.getElementById("achievements");
                const oldAchievements = achievementsDiv.innerHTML;
                achievementsDiv.innerHTML = "";
                const games = userData[username].gamesPlayed;
                const kills = userData[username].kills;
                const deaths = userData[username].deaths;
                const messages = userData[username].messages.length;
                const friends = userData[username].friends.length;
                const titles = userData[username].titles;

                if (games >= 5 && !titles.includes("Veteran")) titles.push("Veteran");
                if (kills >= 10 && !titles.includes("Sharpshooter")) titles.push("Sharpshooter");
                if (deaths < 5 && games >= 5 && !titles.includes("Survivor")) titles.push("Survivor");
                if (kills >= 20 && !titles.includes("Terminator")) titles.push("Terminator");
                if (games >= 10 && !titles.includes("Elite")) titles.push("Elite");
                if (messages >= 50 && !titles.includes("Chat Master")) titles.push("Chat Master");
                if (friends >= 10 && !titles.includes("Socialite")) titles.push("Socialite");
                if (userData[username].wins >= 5 && !titles.includes("Champion")) titles.push("Champion");

                if (games >= 5) addAchievement(achievementsDiv, "🏆 Veteran: 5+ Games", oldAchievements);
                if (kills >= 10) addAchievement(achievementsDiv, "🔫 Sharpshooter: 10+ Kills", oldAchievements);
                if (deaths < 5 && games >= 5) addAchievement(achievementsDiv, "🛡️ Survivor: <5 Deaths in 5+ Games", oldAchievements);
                if (kills >= 20) addAchievement(achievementsDiv, "💀 Terminator: 20+ Kills", oldAchievements);
                if (games >= 10) addAchievement(achievementsDiv, "🌟 Elite: 10+ Games", oldAchievements);
                if (userData[username].isAdmin) addAchievement(achievementsDiv, "👑 Admin: Site Moderator", oldAchievements);
                if (messages >= 50) addAchievement(achievementsDiv, "💬 Chat Master: 50+ Messages", oldAchievements);
                if (friends >= 10) addAchievement(achievementsDiv, "🤝 Socialite: 10+ Friends", oldAchievements);
                if (userData[username].wins >= 5) addAchievement(achievementsDiv, "🏅 Champion: 5+ Wins", oldAchievements);

                saveUserData();
            }

            function addAchievement(div, text, oldHTML) {
                if (!oldHTML.includes(text)) {
                    const achievement = document.createElement("div");
                    achievement.className = "achievement achievement-earned";
                    achievement.innerText = text;
                    div.appendChild(achievement);
                    playSound('fanfare');
                    setTimeout(() => achievement.className = "achievement", 1000);
                } else {
                    div.innerHTML += `<div class="achievement">${text}</div>`;
                }
            }

            function populateTitles() {
                console.log("Populating titles");
                if (!currentUser || !userData[currentUser]) return;
                const select = document.getElementById("title-select");
                select.innerHTML = userData[currentUser].titles.map(title => 
                    `<option value="${title}" ${userData[currentUser].activeTitle === title ? 'selected' : ''}>${title}</option>`
                ).join('');
            }

            function setTitle() {
                console.log("Setting title");
                if (!currentUser || !userData[currentUser]) return;
                const title = document.getElementById("title-select").value;
                userData[currentUser].activeTitle = title;
                saveUserData();
                updateProfile(currentUser);
                alert(`Title set to "${title}"!`);
                playSound('click');
            }

            function replaceEmotes(text) {
                let result = text;
                for (let [shortcut, emoji] of Object.entries(emotes)) {
                    result = result.replace(new RegExp(shortcut, 'g'), emoji);
                }
                return result;
            }

            function addEmote(inputId) {
                console.log("Adding emote to:", inputId);
                if (!currentUser || !userData[currentUser]) return;
                const select = document.getElementById(`emote-select-${inputId.split('-')[1]}`);
                const emote = select.value;
                if (emote) {
                    const input = document.getElementById(inputId);
                    input.value += ` ${emote}`;
                    select.value = "";
                }
            }

            function sendChat() {
                console.log("Send chat clicked");
                if (!currentUser || !userData[currentUser]) {
                    alert("You are banned and cannot chat!");
                    return;
                }
                const message = document.getElementById("chat-input").value.trim();
                if (!message) return alert("Please enter a message.");
                const title = userData[currentUser].activeTitle || "Rookie";
                const chatMessage = `<p><b>${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
                document.getElementById("chat-box").innerHTML += chatMessage;
                chatHistory.push(chatMessage);
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                document.getElementById("chat-input").value = "";
                playSound('click');
                document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
            }

            function loadChatHistory() {
                console.log("Loading chat history");
                if (!currentUser || !userData[currentUser]) {
                    document.getElementById("chat-box").innerHTML = "<p>You are banned and cannot view chat.</p>";
                    document.getElementById("chat-input").disabled = true;
                    document.getElementById("emote-select-chat").disabled = true;
                    document.getElementById("chat-input").placeholder = "Banned users cannot chat";
                    return;
                }
                document.getElementById("chat-box").innerHTML = chatHistory.join('');
                document.getElementById("chat-input").disabled = false;
                document.getElementById("emote-select-chat").disabled = false;
                document.getElementById("chat-input").placeholder = "Type a message...";
            }

            function broadcastMessage() {
                console.log("Broadcast clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const message = prompt("Enter broadcast message:").trim();
                if (!message) return;
                const title = userData[currentUser].activeTitle || "Rookie";
                const broadcast = `<p><b>[BROADCAST] ${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
                chatHistory.push(broadcast);
                document.getElementById("chat-box").innerHTML += broadcast;
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                alert("Message broadcasted!");
                playSound('fanfare');
            }

            function clearChat() {
                console.log("Clear chat clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                if (confirm("Are you sure you want to clear the chat history?")) {
                    chatHistory = [];
                    document.getElementById("chat-box").innerHTML = "";
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    alert("Chat history cleared!");
                    playSound('click');
                }
            }

            function updateMatchHistory(username) {
                console.log("Updating match history for:", username);
                if (!username || !userData[username]) return;
                const historyDiv = document.getElementById("history-list");
                historyDiv.innerHTML = userData[username].history.map(match => `<p>${match}</p>`).join('') || "<p>No matches yet.</p>";
            }

            function fetchRealStats() {
                console.log("Fetch real stats clicked");
                if (!currentUser || !userData[currentUser]) return;
                const simulatedStats = { kills: Math.floor(Math.random() * 50), deaths: Math.floor(Math.random() * 20) };
                userData[currentUser].kills = simulatedStats.kills;
                userData[currentUser].deaths = simulatedStats.deaths;
                saveUserData();
                updateProfile(currentUser);
                playSound('fanfare');
                alert("Stats refreshed from game! (Simulated)");
            }

            function changePassword() {
                console.log("Change password clicked");
                if (!currentUser || !userData[currentUser]) return;
                const currentPass = document.getElementById("current-password").value;
                const newPass = document.getElementById("new-password").value;
                if (!currentPass || !newPass) return alert("Please enter both current and new passwords.");
                if (userData[currentUser].password === currentPass) {
                    if (newPass.length < 6) {
                        alert("New password must be at least 6 characters long!");
                        return;
                    }
                    userData[currentUser].password = newPass;
                    saveUserData();
                    alert("Password changed successfully!");
                    document.getElementById("current-password").value = "";
                    document.getElementById("new-password").value = "";
                    playSound('fanfare');
                } else {
                    alert("Current password is incorrect!");
                }
            }

            function setBio() {
                console.log("Set bio clicked");
                if (!currentUser || !userData[currentUser]) return;
                const bio = document.getElementById("bio-input").value.trim();
                if (bio.length > 50) return alert("Bio cannot exceed 50 characters!");
                userData[currentUser].bio = bio;
                saveUserData();
                updateProfile(currentUser);
                alert("Bio updated!");
                playSound('click');
            }

            function checkDailyReward() {
                console.log("Checking daily reward");
                if (!currentUser || !userData[currentUser]) return;
                const today = new Date().toDateString();
                if (userData[currentUser].lastLogin !== today) {
                    userData[currentUser].kills += 5;
                    userData[currentUser].lastLogin = today;
                    saveUserData();
                    alert("Daily login reward: +5 kills!");
                    playSound('fanfare');
                    updateProfile(currentUser);
                }
            }

            function joinMatchmaking() {
                console.log("Join matchmaking clicked");
                if (!currentUser || !userData[currentUser]) return;
                if (matchmakingQueue.includes(currentUser)) {
                    alert("You are already in the matchmaking queue!");
                    return;
                }
                const team = assignTeam(currentUser);
                matchmakingQueue.push(currentUser);
                alert(`Added to matchmaking queue on ${team} team! Waiting for players...`);
                playSound('click');
                if (!matchmakingInterval) {
                    matchmakingInterval = setInterval(checkMatchmaking, 5000);
                }
            }

            function checkMatchmaking() {
                console.log("Checking matchmaking");
                if (!currentUser || !userData[currentUser]) return;
                const totalPlayers = teams.red.length + teams.pink.length + teams.green.length;
                if (totalPlayers >= 18) {
                    clearInterval(matchmakingInterval);
                    matchmakingInterval = null;
                    alert(`Match started! Teams - Red: ${teams.red.join(', ')}, Pink: ${teams.pink.join(', ')}, Green: ${teams.green.join(', ')}`);
                    teams.red.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                    teams.pink.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                    teams.green.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                    matchmakingQueue = [];
                    for (let user in userData) userData[user].team = null;
                    teams.red = []; teams.pink = []; teams.green = [];
                    saveUserData();
                    playSound('fanfare');
                    if (currentUser) updateProfile(currentUser);
                }
            }

            function addFriend() {
                console.log("Add friend clicked");
                if (!currentUser || !userData[currentUser]) return;
                const friend = document.getElementById("friend-username").value.trim();
                if (!friend) return alert("Please enter a username.");
                if (friend === currentUser) return alert("You cannot add yourself!");
                if (userData[friend]) {
                    if (!userData[currentUser].friends.includes(friend)) {
                        userData[currentUser].friends.push(friend);
                        saveUserData();
                        updateFriendList();
                        alert(`${friend} added to your friends list!`);
                        playSound('click');
                    } else {
                        alert("This user is already your friend!");
                    }
                } else {
                    alert("User not found!");
                }
            }

            function removeFriend(friend) {
                console.log("Remove friend clicked:", friend);
                if (!currentUser || !userData[currentUser]) return;
                if (confirm(`Are you sure you want to remove ${friend} from your friends list?`)) {
                    userData[currentUser].friends = userData[currentUser].friends.filter(f => f !== friend);
                    saveUserData();
                    updateFriendList();
                    alert(`${friend} removed from your friends list!`);
                    playSound('click');
                    checkEmptyGroups();
                }
            }

            function inviteFriendToGroup(friend) {
                console.log("Invite friend to group:", friend);
                if (!currentUser || !userData[currentUser]) return;
                const groupName = prompt(`Enter group chat name to invite ${friend} to:`).trim();
                if (!groupName || !groupChats[groupName]) {
                    alert("Please enter a valid group chat name that exists!");
                    return;
                }
                if (!groupChats[groupName].members.includes(currentUser)) {
                    alert("You must be a member of the group to invite others!");
                    return;
                }
                if (groupChats[groupName].members.includes(friend)) {
                    alert(`${friend} is already in this group!`);
                    return;
                }
                groupChats[groupName].members.push(friend);
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
                alert(`${friend} invited to "${groupName}"!`);
                playSound('click');
            }

            function updateFriendList() {
                console.log("Updating friend list");
                if (!currentUser || !userData[currentUser]) return;
                const friendList = document.getElementById("friend-list");
                friendList.innerHTML = userData[currentUser].friends.map(f => {
                    const status = Math.random() < 0.5 ? "Online" : "In-Game";
                    const title = userData[f].activeTitle || "Rookie";
                    const team = userData[f].team ? userData[f].team : "None";
                    return `<p>${title} ${f} - ${status} (Team: ${team}) 
                        <button class="friend-button" onclick="inviteFriendToGroup('${f}')">Invite</button>
                        <button class="friend-button" onclick="removeFriend('${f}')">Remove</button></p>`;
                }).join('') || "<p>No friends yet.</p>";
            }

            function populateGroupMembers() {
                console.log("Populating group members");
                if (!currentUser || !userData[currentUser]) return;
                const select = document.getElementById("group-members");
                select.innerHTML = userData[currentUser].friends.map(f => `<option value="${f}">${f}</option>`).join('') || "<option value=''>No friends to add</option>";
            }

            function createGroupChat() {
                console.log("Create group chat clicked");
                if (!currentUser || !userData[currentUser]) return;
                const groupName = document.getElementById("group-chat-name").value.trim();
                if (!groupName) return alert("Please enter a group name.");
                if (groupChats[groupName]) return alert("Group already exists!");
                const membersSelect = document.getElementById("group-members");
                const selectedMembers = Array.from(membersSelect.selectedOptions).map(option => option.value);
                if (selectedMembers.length === 0 || (selectedMembers.length === 1 && selectedMembers[0] === '')) {
                    alert("You must add at least one friend to the group chat!");
                    return;
                }
                groupChats[groupName] = {
                    messages: [],
                    members: [currentUser, ...selectedMembers]
                };
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
                updateGroupChatSelect();
                document.getElementById("group-chat-select").value = groupName;
                switchGroupChat();
                alert(`Group "${groupName}" created with members: ${groupChats[groupName].members.join(', ')}!`);
                playSound('click');
                checkEmptyGroups();
            }

            function checkEmptyGroups() {
                console.log("Checking empty groups");
                if (!currentUser || !userData[currentUser]) return;
                for (let groupName in groupChats) {
                    const members = groupChats[groupName].members.filter(m => userData[m] && !userData[m].isBanned);
                    if (members.length <= 1) {
                        delete groupChats[groupName];
                        alert(`Group "${groupName}" removed due to insufficient members!`);
                        playSound('click');
                    }
                }
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
                updateGroupChatSelect();
            }

            function updateGroupChatSelect() {
                console.log("Updating group chat select");
                if (!currentUser || !userData[currentUser]) return;
                const select = document.getElementById("group-chat-select");
                select.innerHTML = "<option value=''>Select a group</option>" + Object.keys(groupChats).map(name => `<option value="${name}">${name}</option>`).join('');
            }

            function switchGroupChat() {
                console.log("Switching group chat");
                if (!currentUser || !userData[currentUser]) return;
                const groupName = document.getElementById("group-chat-select").value;
                if (groupName && groupChats[groupName]) {
                    document.getElementById("group-chat-box").innerHTML = groupChats[groupName].messages.join('');
                } else {
                    document.getElementById("group-chat-box").innerHTML = "<p>Select a group to chat.</p>";
                }
            }

            function sendGroupChat() {
                console.log("Send group chat clicked");
                if (!currentUser || !userData[currentUser]) return;
                const groupName = document.getElementById("group-chat-select").value;
                const message = document.getElementById("group-chat-input").value.trim();
                if (!groupName) return alert("Please select a group.");
                if (!message) return alert("Please enter a message.");
                if (!groupChats[groupName].members.includes(currentUser)) return alert("You are not a member of this group!");
                const title = userData[currentUser].activeTitle || "Rookie";
                const groupMessage = `<p><b>${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
                groupChats[groupName].messages.push(groupMessage);
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
                document.getElementById("group-chat-box").innerHTML += groupMessage;
                document.getElementById("group-chat-input").value = "";
                playSound('click');
                document.getElementById("group-chat-box").scrollTop = document.getElementById("group-chat-box").scrollHeight;
            }

            function sendPrivateMessage() {
                console.log("Send private message clicked");
                if (!currentUser || !userData[currentUser]) return;
                const recipient = document.getElementById("message-recipient").value.trim();
                const message = document.getElementById("message-input").value.trim();
                if (!recipient || !message) return alert("Please enter a recipient and message.");
                if (userData[recipient]) {
                    const title = userData[currentUser].activeTitle || "Rookie";
                    const msg = { from: currentUser, text: replaceEmotes(message), time: new Date().toLocaleString(), title: title };
                    userData[recipient].messages.push(msg);
                    userData[currentUser].messages.push(msg);
                    saveUserData();
                    document.getElementById("message-input").value = "";
                    updateMessages();
                    alert(`Message sent to ${recipient}!`);
                    playSound('click');
                } else {
                    alert("Recipient not found!");
                }
            }

            function updateMessages() {
                console.log("Updating messages");
                if (!currentUser || !userData[currentUser]) return;
                const messageBox = document.getElementById("message-box");
                messageBox.innerHTML = userData[currentUser].messages.map(m => 
                    `<p><b>${m.title} ${m.from}:</b> ${m.text} (${m.time})</p>`
                ).join('') || "<p>No messages yet.</p>";
            }

            function banUser() {
                console.log("Ban user clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const target = document.getElementById("admin-target").value.trim();
                const reason = document.getElementById("ban-reason").value.trim();
                if (!target) return alert("Please enter a username to ban.");
                if (target === currentUser) return alert("You cannot ban yourself!");
                if (userData[target]) {
                    if (userData[target].isOwner) return alert("You cannot ban the owner!");
                    userData[target].isBanned = true;
                    userData[target].banReason = reason || "No reason provided";
                    if (userData[target].team) teams[userData[target].team] = teams[userData[target].team].filter(u => u !== target);
                    userData[target].team = null;
                    saveUserData();
                    alert(`${target} has been banned! Reason: ${userData[target].banReason}`);
                    playSound('click');
                    updateLeaderboard();
                    checkEmptyGroups();
                    if (target === currentUser) showBannedNotice();
                } else {
                    alert("User not found!");
                }
            }

            function unbanUser() {
                console.log("Unban user clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const target = document.getElementById("admin-target").value.trim();
                if (!target) return alert("Please enter a username to unban.");
                if (userData[target]) {
                    userData[target].isBanned = false;
                    userData[target].banReason = '';
                    saveUserData();
                    alert(`${target} has been unbanned!`);
                    playSound('click');
                    updateLeaderboard();
                } else {
                    alert("User not found!");
                }
            }

            function makeAdmin() {
                console.log("Make admin clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const target = document.getElementById("admin-target").value.trim();
                if (!target) return alert("Please enter a username.");
                if (target === currentUser) return alert("You are already an admin!");
                if (userData[target]) {
                    userData[target].isAdmin = true;
                    saveUserData();
                    alert(`${target} is now an admin!`);
                    playSound('fanfare');
                } else {
                    alert("User not found!");
                }
            }

            function removeAdmin() {
                console.log("Remove admin clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const target = document.getElementById("admin-target").value.trim();
                if (!target) return alert("Please enter a username.");
                if (target === currentUser) return alert("You cannot remove your own admin status!");
                if (target === 'Halaldeveloper') return alert("You cannot remove the owner's admin status!");
                if (userData[target]) {
                    userData[target].isAdmin = false;
                    saveUserData();
                    alert(`${target} is no longer an admin!`);
                    playSound('click');
                } else {
                    alert("User not found!");
                }
            }

            function resetUserStats() {
                console.log("Reset user stats clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const target = document.getElementById("admin-target").value.trim();
                if (!target) return alert("Please enter a username.");
                if (userData[target]) {
                    userData[target].kills = 0;
                    userData[target].deaths = 0;
                    userData[target].gamesPlayed = 0;
                    userData[target].wins = 0;
                    userData[target].history = [];
                    userData[target].titles = ["Rookie"];
                    userData[target].activeTitle = "Rookie";
                    saveUserData();
                    alert(`${target}'s stats have been reset!`);
                    playSound('click');
                    if (target === currentUser) updateProfile(currentUser);
                } else {
                    alert("User not found!");
                }
            }

            function massBan() {
                console.log("Mass ban clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const targets = prompt("Enter usernames to ban (comma-separated):")?.trim();
                const reason = document.getElementById("ban-reason").value.trim();
                if (!targets) return alert("Please enter at least one username.");
                const userList = targets.split(',').map(t => t.trim());
                let banned = [];
                userList.forEach(target => {
                    if (userData[target] && target !== currentUser && !userData[target].isOwner) {
                        userData[target].isBanned = true;
                        userData[target].banReason = reason || "Mass ban - no reason provided";
                        if (userData[target].team) teams[userData[target].team] = teams[userData[target].team].filter(u => u !== target);
                        userData[target].team = null;
                        banned.push(target);
                    }
                });
                saveUserData();
                alert(`Banned: ${banned.join(', ') || 'None'}`);
                playSound('click');
                updateLeaderboard();
                checkEmptyGroups();
                if (banned.includes(currentUser)) showBannedNotice();
            }

            function massUnban() {
                console.log("Mass unban clicked");
                if (!currentUser || !userData[currentUser] || !userData[currentUser]?.isAdmin) return alert("You are not an admin!");
                const targets = prompt("Enter usernames to unban (comma-separated):")?.trim();
                if (!targets) return alert("Please enter at least one username.");
                const userList = targets.split(',').map(t => t.trim());
                let unbanned = [];
                userList.forEach(target => {
                    if (userData[target]) {
                        userData[target].isBanned = false;
                        userData[target].banReason = '';
                        unbanned.push(target);
                    }
                });
                saveUserData();
                alert(`Unbanned: ${unbanned.join(', ') || 'None'}`);
                playSound('click');
                updateLeaderboard();
            }

            function exportData() {
                console.log("Export data clicked");
                if (!currentUser || !userData[currentUser]) return;
                const data = {
                    userData: userData,
                    chatHistory: chatHistory,
                    groupChats: groupChats,
                    soundSettings: soundSettings,
                    teams: teams
                };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "laser_tag_data.json";
                a.click();
                URL.revokeObjectURL(url);
                alert("Data exported! Save this file to import later.");
                playSound('click');
            }
        });

        // Additional CSS for themes
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            body.dark { background: #1a1a1a; color: #fff; }
            body.light { background: #f0f0f0; color: #000; }
            body.light header { background: #ddd; }
            body.light section, body.light .container { background: #fff; }
            body.light input, body.light select, body.light textarea { background: #eee; color: #000; border: 1px solid #ccc; }
            body.light #chat-box, body.light #group-chat-box, body.light #message-box, body.light #history-list { background: #eee; }
            body.light .achievement { background: #ddd; }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
