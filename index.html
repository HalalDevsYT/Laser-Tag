<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laser Tag</title>
    <link rel="icon" href="LaserIcon.png" type="image/png">
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #121212, #ff0000, #0000ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .light-mode { background: white; color: black; }
        .neon-red { background: #300; color: #f88; }
        .laser-blue { background: #013; color: #8cf; }
        .cosmic { background: linear-gradient(45deg, #0a001f, #ff00ff, #00ffff); background-size: 400% 400%; animation: gradientBG 10s ease infinite; }
        
        header {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 0 20px #ff0000;
        }
        
        header img {
            height: 90px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        header img:hover { transform: scale(1.1); box-shadow: 0 0 15px #ff0000; }
        
        header h1 { margin: 0; flex-grow: 1; text-align: left; padding-left: 20px; }
        
        .search-bar {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #ff0000;
            font-size: 14px;
            width: 200px;
            background: #222;
            color: white;
            transition: border-color 0.3s;
        }
        
        .search-bar:focus { border-color: #00ff00; outline: none; }
        
        .button {
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            background: #ff0000;
            color: white;
            transition: all 0.3s;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px;
            box-shadow: 0 0 10px #ff0000;
        }
        
        .button:hover {
            background: #cc0000;
            transform: scale(1.05);
            box-shadow: 0 0 20px #ff0000;
        }

        .friend-button {
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }

        .container {
            max-width: 450px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(51, 51, 51, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.7);
            transition: transform 0.3s, opacity 0.3s;
        }

        .container:hover { transform: translateY(-5px); }
        .container.hidden { opacity: 0; pointer-events: none; }

        .input-field {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #ff0000;
            font-size: 14px;
            background: #222;
            color: white;
            transition: border-color 0.3s;
        }

        .input-field:focus { border-color: #00ff00; outline: none; }

        .hidden { display: none; }

        #leaderboard, #rules, #chat, #match-history, #admin-tools, #friends, #messages, #group-chat {
            margin: 20px auto;
            max-width: 450px;
            padding: 10px;
            background: rgba(34, 34, 34, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 15px #ff0000;
        }

        .achievement {
            background: #444;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ff0000;
            animation: pulse 2s infinite;
            position: relative;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 5px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000; }
        }

        .achievement-earned {
            animation: popIn 0.5s ease-out forwards;
            background: #ff4444;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        #chat-box, #message-box, #group-chat-box {
            height: 150px;
            overflow-y: scroll;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        #music-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px #ff0000;
        }

        #banned-notice {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            z-index: 1000;
        }

        #player-count {
            font-size: 18px;
            margin: 10px 0;
        }

        @media (max-width: 600px) {
            .container, #leaderboard, #rules, #chat, #match-history, #admin-tools, #friends, #messages, #group-chat {
                max-width: 90%;
            }
            .button {
                padding: 10px 20px;
                font-size: 14px;
            }
            .friend-button {
                padding: 6px 12px;
                font-size: 12px;
            }
            header img { height: 60px; }
            .search-bar { width: 150px; }
            #music-toggle { padding: 5px; font-size: 12px; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div>
            <img src="LaserIcon.png" alt="Laser Tag Icon" onclick="showPage('home')">
            <h1>Laser Tag</h1>
        </div>
        <input type="text" class="search-bar" id="search-bar" placeholder="Search users..." onkeyup="searchUsers()">
    </header>
    
    <main id="content">
        <section id="home">
            <h2>Join the Battle!</h2>
            <p id="player-count">Players Online: <span id="online-players">Loading...</span></p>
            <button class="button" id="login-btn" onclick="playSound('click'); showPage('login-form')">Login</button>
            <button class="button" id="register-btn" onclick="playSound('click'); showPage('register-form')">Register</button>
            <button class="button hidden" id="profile-btn" onclick="playSound('click'); showPage('profile')">Profile</button>
            <button class="button" id="rules-btn" onclick="playSound('click'); showPage('rules')">Rules</button>
            <button class="button" id="settings-btn" onclick="playSound('click'); showPage('settings')">Settings</button>
            <button class="button hidden" id="play-btn" onclick="playSound('fanfare'); launchRoblox()">Play Now</button>
            <button class="button hidden" id="join-friend-btn" onclick="playSound('click'); joinFriend()">Join Friend</button>
            <button class="button hidden" id="admin-tools-btn" onclick="playSound('click'); showPage('admin-tools')">Admin Tools</button>
            <button class="button hidden" id="friends-btn" onclick="playSound('click'); showPage('friends')">Friends</button>
            <button class="button hidden" id="messages-btn" onclick="playSound('click'); showPage('messages')">Messages</button>
            <button class="button hidden" id="matchmaking-btn" onclick="joinMatchmaking()">Join Matchmaking</button>
            <button class="button hidden" id="group-chat-btn" onclick="playSound('click'); showPage('group-chat')">Group Chat</button>
            <button class="button hidden" id="logout-btn" onclick="logout()">Logout</button>
        </section>
        
        <div id="login-form" class="container hidden">
            <h2>Login</h2>
            <input type="text" id="login-username" class="input-field" placeholder="Username">
            <input type="password" id="login-password" class="input-field" placeholder="Password">
            <button class="button" onclick="login()">Login</button>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="register-form" class="container hidden">
            <h2>Register</h2>
            <input type="text" id="reg-username" class="input-field" placeholder="Username">
            <input type="password" id="reg-password" class="input-field" placeholder="Password">
            <button class="button" onclick="register()">Register</button>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="profile" class="container hidden">
            <h2>Profile</h2>
            <p>Welcome, <span id="user-title">Rookie</span> <span id="user-name">User</span> <span id="user-badge"></span>!</p>
            <p>Bio: <span id="user-bio">No bio set</span></p>
            <p>Games Played: <span id="games-played">0</span></p>
            <p>Kills: <input type="number" id="kills" class="input-field" value="0" min="0" onchange="updateStats()"></p>
            <p>Deaths: <input type="number" id="deaths" class="input-field" value="0" min="0" onchange="updateStats()"></p>
            <p>K/D Ratio: <span id="kd-ratio">0.00</span></p>
            <p>Win Rate: <span id="win-rate">0%</span></p>
            <div id="achievements"></div>
            <button class="button" onclick="fetchRealStats()">Refresh Stats</button>
            <button class="button" onclick="logout()">Logout</button>
        </div>

        <div id="settings" class="container hidden">
            <h2>Settings</h2>
            <h3>Appearance</h3>
            <button class="button" onclick="setTheme('dark')">Dark Mode</button>
            <button class="button" onclick="setTheme('light')">Light Mode</button>
            <button class="button" onclick="setTheme('neon-red')">Neon Red</button>
            <button class="button" onclick="setTheme('laser-blue')">Laser Blue</button>
            <button class="button" onclick="setTheme('cosmic')">Cosmic</button>
            <h3>Button Color</h3>
            <select id="button-color" class="input-field" onchange="setButtonColor()">
                <option value="#ff0000">Red</option>
                <option value="#00ff00">Green</option>
                <option value="#0000ff">Blue</option>
                <option value="#ff00ff">Purple</option>
            </select>
            <h3>Account</h3>
            <input type="password" id="current-password" class="input-field" placeholder="Current Password">
            <input type="password" id="new-password" class="input-field" placeholder="New Password">
            <button class="button" onclick="changePassword()">Change Password</button>
            <input type="text" id="bio-input" class="input-field" placeholder="Set your bio" maxlength="50">
            <button class="button" onclick="setBio()">Update Bio</button>
            <h3>Title</h3>
            <select id="title-select" class="input-field" onchange="setTitle()"></select>
            <h3>Sound Preferences</h3>
            <label><input type="checkbox" id="mute-click" onchange="updateSoundSettings()"> Mute Click</label><br>
            <label><input type="checkbox" id="mute-fanfare" onchange="updateSoundSettings()"> Mute Fanfare</label><br>
            <label><input type="checkbox" id="mute-ambient" onchange="updateSoundSettings()"> Mute Ambient</label><br>
            <button class="button" onclick="exportData()">Export Data</button>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="rules" class="container hidden">
            <h2>Game Rules</h2>
            <p>1. Tag opponents with your laser to score kills!</p>
            <p>2. Avoid hits—each hit counts as a death.</p>
            <p>3. Most kills in 5 minutes wins!</p>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="admin-tools" class="container hidden">
            <h2>Admin Tools</h2>
            <input type="text" id="admin-target" class="input-field" placeholder="Target Username">
            <input type="text" id="ban-reason" class="input-field" placeholder="Ban Reason (optional)">
            <button class="button" onclick="banUser()">Ban User</button>
            <button class="button" onclick="unbanUser()">Unban User</button>
            <button class="button" onclick="makeAdmin()">Make Admin</button>
            <button class="button" onclick="removeAdmin()">Remove Admin</button>
            <button class="button" onclick="resetUserStats()">Reset User Stats</button>
            <button class="button" onclick="massBan()">Mass Ban</button>
            <button class="button" onclick="massUnban()">Mass Unban</button>
            <button class="button" onclick="broadcastMessage()">Broadcast Message</button>
            <button class="button" onclick="clearChat()">Clear Chat</button>
            <div id="reports" style="margin-top: 10px;"></div>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="friends" class="container hidden">
            <h2>Friends</h2>
            <input type="text" id="friend-username" class="input-field" placeholder="Add Friend Username">
            <button class="button" onclick="addFriend()">Add Friend</button>
            <div id="friend-list"></div>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="messages" class="container hidden">
            <h2>Messages</h2>
            <input type="text" id="message-recipient" class="input-field" placeholder="Recipient Username">
            <div id="message-box"></div>
            <input type="text" id="message-input" class="input-field" placeholder="Type a private message...">
            <select id="emote-select-message" class="input-field" onchange="addEmote('message-input')">
                <option value="">Add Emote</option>
                <option value=":smile:">😊</option>
                <option value=":fire:">🔥</option>
                <option value=":thumbsup:">👍</option>
                <option value=":heart:">❤️</option>
                <option value=":laugh:">😂</option>
            </select>
            <button class="button" onclick="sendPrivateMessage()">Send</button>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="group-chat" class="container hidden">
            <h2>Group Chat</h2>
            <input type="text" id="group-chat-name" class="input-field" placeholder="Group Name">
            <select id="group-members" class="input-field" multiple style="height: 100px;"></select>
            <button class="button" onclick="createGroupChat()">Create Group</button>
            <select id="group-chat-select" class="input-field" onchange="switchGroupChat()">
                <option value="">Select a group</option>
            </select>
            <div id="group-chat-box"></div>
            <input type="text" id="group-chat-input" class="input-field" placeholder="Type a group message...">
            <select id="emote-select-group" class="input-field" onchange="addEmote('group-chat-input')">
                <option value="">Add Emote</option>
                <option value=":smile:">😊</option>
                <option value=":fire:">🔥</option>
                <option value=":thumbsup:">👍</option>
                <option value=":heart:">❤️</option>
                <option value=":laugh:">😂</option>
            </select>
            <button class="button" onclick="sendGroupChat()">Send</button>
            <button class="button" onclick="showPage('home')">Back</button>
        </div>

        <div id="leaderboard" class="hidden">
            <h3>Leaderboard</h3>
            <p>Top Player: <span id="top-player">N/A</span> - <span id="top-score">0</span> Kills</p>
        </div>

        <div id="chat" class="hidden">
            <h3>Chat</h3>
            <div id="chat-box"></div>
            <input type="text" id="chat-input" class="input-field" placeholder="Type a message...">
            <select id="emote-select-chat" class="input-field" onchange="addEmote('chat-input')">
                <option value="">Add Emote</option>
                <option value=":smile:">😊</option>
                <option value=":fire:">🔥</option>
                <option value=":thumbsup:">👍</option>
                <option value=":heart:">❤️</option>
                <option value=":laugh:">😂</option>
            </select>
            <button class="button" onclick="sendChat()">Send</button>
        </div>

        <div id="match-history" class="hidden">
            <h3>Match History</h3>
            <div id="history-list"></div>
        </div>

        <div id="banned-notice" class="hidden">
            <h2>You are banned!</h2>
            <p>Reason: <span id="ban-reason"></span></p>
            <button class="button" onclick="logout()">Logout</button>
        </div>
    </main>
    
    <div id="music-toggle">
        <label><input type="checkbox" id="mute-music" onchange="toggleMusic()"> Toggle Music</label>
    </div>
    
    <audio id="click-sound" src="https://www.myinstants.com/media/sounds/button-click.mp3" preload="auto"></audio>
    <audio id="fanfare-sound" src="https://www.myinstants.com/media/sounds/fanfare.mp3" preload="auto"></audio>
    <audio id="ambient-sound" src="https://www.myinstants.com/media/sounds/sci-fi-ambience.mp3" preload="auto" loop></audio>
    <audio id="music" src="wedding_song.mp3" preload="auto" loop></audio>
    
    <script>
        let isLoggedIn = false;
        let currentUser = null;
        let userData = JSON.parse(localStorage.getItem('userData')) || {};
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let groupChats = JSON.parse(localStorage.getItem('groupChats')) || {};
        let soundSettings = JSON.parse(localStorage.getItem('soundSettings')) || {
            click: true,
            fanfare: true,
            ambient: true,
            music: true
        };
        let matchmakingQueue = [];
        const teams = {
            red: [],
            pink: [],
            green: []
        };
        const teamOrder = ['red', 'pink', 'green'];
        const maxTeamSize = 6;
        const emotes = {
            ":smile:": "😊",
            ":fire:": "🔥",
            ":thumbsup:": "👍",
            ":heart:": "❤️",
            ":laugh:": "😂"
        };
        const universeId = "6558675549"; // Your provided Universe ID

        if (!userData['Halaldeveloper']) {
            userData['Halaldeveloper'] = {
                password: 'HOOKfor9',
                gamesPlayed: 0,
                kills: 0,
                deaths: 0,
                wins: 0,
                history: [],
                friends: [],
                messages: [],
                reports: [],
                bio: '',
                lastLogin: null,
                team: null,
                titles: ["Rookie"],
                activeTitle: "Rookie",
                isAdmin: true,
                isOwner: true,
                isBanned: false,
                banReason: ''
            };
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        window.onload = () => {
            currentUser = localStorage.getItem('currentUser');
            isLoggedIn = !!currentUser && !!userData[currentUser] && !userData[currentUser].isBanned;
            if (currentUser && userData[currentUser]?.isBanned) {
                showBannedNotice();
            } else {
                document.getElementById("mute-click").checked = !soundSettings.click;
                document.getElementById("mute-fanfare").checked = !soundSettings.fanfare;
                document.getElementById("mute-ambient").checked = !soundSettings.ambient;
                document.getElementById("mute-music").checked = !soundSettings.music;
                if (soundSettings.ambient) document.getElementById("ambient-sound").play().catch(() => console.log("Audio blocked"));
                if (soundSettings.music) document.getElementById("music").play().catch(() => console.log("Audio blocked"));
                loadChatHistory();
                updatePlayerCount();
                if (isLoggedIn) {
                    updateUI();
                    updateProfile(currentUser);
                    checkDailyReward();
                    populateGroupMembers();
                    populateTitles();
                    showPage('home');
                }
            }
        };

        window.onbeforeunload = () => {
            if (!userData[currentUser]?.isBanned) {
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('groupChats', JSON.stringify(groupChats));
                localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
            }
        };

        function showBannedNotice() {
            document.getElementById("content").classList.add("hidden");
            document.getElementById("banned-notice").classList.remove("hidden");
            document.getElementById("ban-reason").innerText = userData[currentUser].banReason || "No reason provided";
            localStorage.removeItem('currentUser');
            isLoggedIn = false;
            currentUser = null;
        }

        function updatePlayerCount() {
            // Simulated for now; replace with real API call after backend setup
            const playerCount = Math.floor(Math.random() * 50); // Random 0-50
            document.getElementById("online-players").innerText = playerCount;
            setTimeout(updatePlayerCount, 10000); // Update every 10 seconds
        }

        function showPage(page) {
            if (userData[currentUser]?.isBanned) {
                showBannedNotice();
                return;
            }
            document.querySelectorAll("main section, .container").forEach(section => {
                section.classList.add("hidden");
                section.style.opacity = "0";
            });
            const target = document.getElementById(page);
            target.classList.remove("hidden");
            setTimeout(() => target.style.opacity = "1", 10);
            if (isLoggedIn && page === 'home') {
                ['leaderboard', 'chat', 'match-history'].forEach(id => {
                    document.getElementById(id).classList.remove('hidden');
                });
            } else {
                ['leaderboard', 'chat', 'match-history'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
            if (page === 'group-chat' && isLoggedIn) populateGroupMembers();
            if (page === 'settings' && isLoggedIn) populateTitles();
            if (page === 'friends' && isLoggedIn) updateFriendList();
        }

        function login() {
            const username = document.getElementById("login-username").value.trim();
            const password = document.getElementById("login-password").value;
            if (!username || !password) return alert("Please enter both username and password.");
            if (userData[username] && userData[username].password === password) {
                if (userData[username].isBanned) {
                    alert(`You are banned! Reason: ${userData[username].banReason || 'No reason provided'}`);
                    currentUser = username;
                    showBannedNotice();
                    return;
                }
                playSound('fanfare');
                alert("Login successful!");
                currentUser = username;
                isLoggedIn = true;
                localStorage.setItem('currentUser', currentUser);
                document.getElementById("user-name").innerText = username;
                userData[currentUser].friends.forEach(f => {
                    if (userData[f]) alert(`${userData[f].activeTitle || "Rookie"} ${f} saw you log in!`);
                });
                updateUI();
                updateProfile(username);
                checkDailyReward();
                showPage('home');
            } else {
                alert("Invalid username or password.");
            }
        }

        function register() {
            const username = document.getElementById("reg-username").value.trim();
            const password = document.getElementById("reg-password").value;
            if (!username || !password) return alert("Please enter both username and password.");
            if (userData[username]) {
                alert("Username already taken!");
            } else if (username.length < 3) {
                alert("Username must be at least 3 characters long!");
            } else {
                userData[username] = {
                    password,
                    gamesPlayed: 0,
                    kills: 0,
                    deaths: 0,
                    wins: 0,
                    history: [],
                    friends: [],
                    messages: [],
                    reports: [],
                    bio: '',
                    lastLogin: null,
                    team: null,
                    titles: ["Rookie"],
                    activeTitle: "Rookie",
                    isAdmin: false,
                    isBanned: false,
                    banReason: ''
                };
                localStorage.setItem('userData', JSON.stringify(userData));
                playSound('fanfare');
                alert("Registration successful! Please login.");
                showPage('login-form');
            }
        }

        function logout() {
            if (userData[currentUser]?.isBanned) {
                document.getElementById("banned-notice").classList.add("hidden");
                document.getElementById("content").classList.remove("hidden");
            } else if (userData[currentUser].team) {
                teams[userData[currentUser].team] = teams[userData[currentUser].team].filter(u => u !== currentUser);
                userData[currentUser].team = null;
            }
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('currentUser');
            playSound('click');
            alert("You have been logged out.");
            updateUI();
            showPage('home');
        }

        function updateUI() {
            if (userData[currentUser]?.isBanned) {
                showBannedNotice();
                return;
            }
            document.getElementById("login-btn").classList.toggle("hidden", isLoggedIn);
            document.getElementById("register-btn").classList.toggle("hidden", isLoggedIn);
            document.getElementById("profile-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("play-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("join-friend-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("logout-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("admin-tools-btn").classList.toggle("hidden", !isLoggedIn || !userData[currentUser]?.isAdmin);
            document.getElementById("friends-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("messages-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("matchmaking-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("group-chat-btn").classList.toggle("hidden", !isLoggedIn);
            document.getElementById("chat").classList.toggle("hidden", !isLoggedIn);
            setButtonColor();
        }

        function updateProfile(username) {
            if (userData[username]?.isBanned) {
                showBannedNotice();
                return;
            }
            document.getElementById("user-title").innerText = userData[username].activeTitle || "Rookie";
            document.getElementById("user-name").innerText = username;
            document.getElementById("user-badge").innerText = userData[username].isOwner ? "👑" : userData[username].isAdmin ? "⭐" : "";
            document.getElementById("user-bio").innerText = userData[username].bio || "No bio set";
            document.getElementById("games-played").innerText = userData[username].gamesPlayed || 0;
            document.getElementById("kills").value = userData[username].kills || 0;
            document.getElementById("deaths").value = userData[username].deaths || 0;
            const kd = userData[username].deaths === 0 ? userData[username].kills : (userData[username].kills / userData[username].deaths).toFixed(2);
            document.getElementById("kd-ratio").innerText = kd;
            const winRate = userData[username].gamesPlayed === 0 ? 0 : ((userData[username].wins / userData[username].gamesPlayed) * 100).toFixed(0);
            document.getElementById("win-rate").innerText = `${winRate}%`;
            updateLeaderboard();
            updateAchievements(username);
            updateMatchHistory(username);
            updateFriendList();
            updateMessages();
            updateGroupChatSelect();
            updateReports();
            populateTitles();
        }

        function updateStats() {
            if (userData[currentUser]?.isBanned) return;
            const username = document.getElementById("user-name").innerText;
            const kills = parseInt(document.getElementById("kills").value) || 0;
            const deaths = parseInt(document.getElementById("deaths").value) || 0;
            if (kills < 0 || deaths < 0) return alert("Stats cannot be negative!");
            userData[username].kills = kills;
            userData[username].deaths = deaths;
            localStorage.setItem('userData', JSON.stringify(userData));
            updateProfile(username);
        }

        function setTheme(theme) {
            if (userData[currentUser]?.isBanned) return;
            document.body.className = '';
            document.body.classList.add(theme);
            playSound('click');
        }

        function setButtonColor() {
            if (userData[currentUser]?.isBanned) return;
            const color = isLoggedIn && userData[currentUser].buttonColor ? userData[currentUser].buttonColor : document.getElementById("button-color").value;
            document.querySelectorAll(".button, .friend-button").forEach(btn => {
                btn.style.background = color;
                btn.style.boxShadow = `0 0 10px ${color}`;
                btn.onmouseover = () => {
                    btn.style.background = darkenColor(color);
                    btn.style.boxShadow = `0 0 20px ${color}`;
                };
                btn.onmouseout = () => {
                    btn.style.background = color;
                    btn.style.boxShadow = `0 0 10px ${color}`;
                };
            });
            if (isLoggedIn) {
                userData[currentUser].buttonColor = color;
                localStorage.setItem('userData', JSON.stringify(userData));
            }
        }

        function darkenColor(hex) {
            let r = parseInt(hex.slice(1, 3), 16) * 0.8;
            let g = parseInt(hex.slice(3, 5), 16) * 0.8;
            let b = parseInt(hex.slice(5, 7), 16) * 0.8;
            return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
        }

        function playSound(type) {
            if (userData[currentUser]?.isBanned) return;
            if (type === 'click' && !soundSettings.click) return;
            if (type === 'fanfare' && !soundSettings.fanfare) return;
            const sound = document.getElementById(type === 'click' ? 'click-sound' : 'fanfare-sound');
            sound.currentTime = 0;
            sound.play().catch(() => console.log("Audio blocked by browser"));
        }

        function updateSoundSettings() {
            if (userData[currentUser]?.isBanned) return;
            soundSettings.click = !document.getElementById("mute-click").checked;
            soundSettings.fanfare = !document.getElementById("mute-fanfare").checked;
            soundSettings.ambient = !document.getElementById("mute-ambient").checked;
            soundSettings.music = !document.getElementById("mute-music").checked;
            const ambient = document.getElementById("ambient-sound");
            const music = document.getElementById("music");
            if (soundSettings.ambient) ambient.play().catch(() => console.log("Audio blocked")); else ambient.pause();
            if (soundSettings.music) music.play().catch(() => console.log("Audio blocked")); else music.pause();
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
        }

        function toggleMusic() {
            if (userData[currentUser]?.isBanned) return;
            soundSettings.music = !document.getElementById("mute-music").checked;
            const music = document.getElementById("music");
            if (soundSettings.music) music.play().catch(() => console.log("Audio blocked")); else music.pause();
            localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
        }

        function launchRoblox() {
            if (userData[currentUser]?.isBanned) return;
            window.open("https://www.roblox.com/games/109363541562257/Laser-Tag", "_blank");
            userData[currentUser].gamesPlayed = (userData[currentUser].gamesPlayed || 0) + 1;
            const team = assignTeam(currentUser);
            userData[currentUser].history.push(`Played on ${team} team on ${new Date().toLocaleString()}`);
            if (Math.random() < 0.3) userData[currentUser].wins = (userData[currentUser].wins || 0) + 1;
            localStorage.setItem('userData', JSON.stringify(userData));
            updateProfile(currentUser);
            playSound('fanfare');
            alert(`Launching Laser Tag on ${team} team!`);
        }

        function joinFriend() {
            if (userData[currentUser]?.isBanned) return;
            const friend = prompt("Enter friend's username:").trim();
            if (!friend) return;
            if (userData[friend]) {
                if (userData[friend].isBanned) {
                    alert(`${friend} is banned and cannot be joined!`);
                    return;
                }
                const team = userData[friend].team || assignTeam(currentUser);
                userData[currentUser].team = team;
                teams[team].push(currentUser);
                alert(`Joining ${friend}'s game on ${team} team! (Simulated)`);
                playSound('fanfare');
            } else {
                alert("Friend not found!");
            }
        }

        function assignTeam(username) {
            if (userData[username]?.isBanned) return null;
            if (userData[username].team) {
                if (teams[userData[username].team].length < maxTeamSize) return userData[username].team;
                teams[userData[username].team] = teams[userData[username].team].filter(u => u !== username);
            }
            const totalPlayers = teams.red.length + teams.pink.length + teams.green.length;
            const teamIndex = totalPlayers % 3;
            const team = teamOrder[teamIndex];
            if (teams[team].length < maxTeamSize) {
                teams[team].push(username);
                userData[username].team = team;
                localStorage.setItem('userData', JSON.stringify(userData));
                return team;
            }
            return assignTeam(username);
        }

        function updateLeaderboard() {
            if (userData[currentUser]?.isBanned) return;
            let topPlayer = "N/A";
            let topScore = 0;
            for (let user in userData) {
                if (!userData[user].isBanned && userData[user].kills > topScore) {
                    topScore = userData[user].kills;
                    topPlayer = user;
                }
            }
            document.getElementById("top-player").innerText = topPlayer;
            document.getElementById("top-score").innerText = topScore;
        }

        function searchUsers() {
            if (userData[currentUser]?.isBanned) return;
            const query = document.getElementById("search-bar").value.trim().toLowerCase();
            if (!query) return alert("Please enter a search term.");
            if (!isLoggedIn) return alert("You must be logged in to search users.");
            for (let user in userData) {
                if (user.toLowerCase().includes(query)) {
                    const status = userData[user].isBanned ? ` (Banned: ${userData[user].banReason || 'No reason'})` : userData[user].isAdmin ? " (Admin)" : "";
                    const badge = userData[user].isOwner ? "👑" : userData[user].isAdmin ? "⭐" : "";
                    const title = userData[user].activeTitle || "Rookie";
                    const team = userData[user].team ? `Team: ${userData[user].team}` : "No team";
                    alert(`Found: ${title} ${user}${badge}${status} - Kills: ${userData[user].kills}, Deaths: ${userData[user].deaths}\n${team}\nBio: ${userData[user].bio || 'No bio'}\nReport this user?\nType "yes" to report.`);
                    if (prompt("Report this user? (yes/no)").toLowerCase() === "yes") {
                        reportUser(user);
                    }
                    return;
                }
            }
            alert("No user found matching your search.");
        }

        function reportUser(target) {
            if (userData[currentUser]?.isBanned) return;
            userData[target].reports.push({
                from: currentUser,
                reason: prompt("Reason for reporting this user:"),
                time: new Date().toLocaleString()
            });
            localStorage.setItem('userData', JSON.stringify(userData));
            alert(`${target} has been reported!`);
            updateReports();
        }

        function updateReports() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return;
            const reportsDiv = document.getElementById("reports");
            let allReports = [];
            for (let user in userData) {
                if (userData[user].reports.length > 0) {
                    allReports.push(`<p><b>${user}:</b></p>` + userData[user].reports.map(r => `<p>Reported by ${r.from}: ${r.reason} (${r.time})</p>`).join(''));
                }
            }
            reportsDiv.innerHTML = allReports.length > 0 ? allReports.join('') : "<p>No reports yet.</p>";
        }

        function updateAchievements(username) {
            if (userData[username]?.isBanned) return;
            const achievementsDiv = document.getElementById("achievements");
            const oldAchievements = achievementsDiv.innerHTML;
            achievementsDiv.innerHTML = "";
            const games = userData[username].gamesPlayed;
            const kills = userData[username].kills;
            const deaths = userData[username].deaths;
            const messages = userData[username].messages.length;
            const friends = userData[username].friends.length;
            const titles = userData[username].titles;

            if (games >= 5 && !titles.includes("Veteran")) titles.push("Veteran");
            if (kills >= 10 && !titles.includes("Sharpshooter")) titles.push("Sharpshooter");
            if (deaths < 5 && games >= 5 && !titles.includes("Survivor")) titles.push("Survivor");
            if (kills >= 20 && !titles.includes("Terminator")) titles.push("Terminator");
            if (games >= 10 && !titles.includes("Elite")) titles.push("Elite");
            if (messages >= 50 && !titles.includes("Chat Master")) titles.push("Chat Master");
            if (friends >= 10 && !titles.includes("Socialite")) titles.push("Socialite");
            if (userData[username].wins >= 5 && !titles.includes("Champion")) titles.push("Champion");

            if (games >= 5) addAchievement(achievementsDiv, "🏆 Veteran: 5+ Games", oldAchievements);
            if (kills >= 10) addAchievement(achievementsDiv, "🔫 Sharpshooter: 10+ Kills", oldAchievements);
            if (deaths < 5 && games >= 5) addAchievement(achievementsDiv, "🛡️ Survivor: <5 Deaths in 5+ Games", oldAchievements);
            if (kills >= 20) addAchievement(achievementsDiv, "💀 Terminator: 20+ Kills", oldAchievements);
            if (games >= 10) addAchievement(achievementsDiv, "🌟 Elite: 10+ Games", oldAchievements);
            if (userData[username].isAdmin) addAchievement(achievementsDiv, "👑 Admin: Site Moderator", oldAchievements);
            if (messages >= 50) addAchievement(achievementsDiv, "💬 Chat Master: 50+ Messages", oldAchievements);
            if (friends >= 10) addAchievement(achievementsDiv, "🤝 Socialite: 10+ Friends", oldAchievements);
            if (userData[username].wins >= 5) addAchievement(achievementsDiv, "🏅 Champion: 5+ Wins", oldAchievements);

            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function addAchievement(div, text, oldHTML) {
            if (!oldHTML.includes(text)) {
                const achievement = document.createElement("div");
                achievement.className = "achievement achievement-earned";
                achievement.innerText = text;
                div.appendChild(achievement);
                playSound('fanfare');
                setTimeout(() => achievement.className = "achievement", 1000);
            } else {
                div.innerHTML += `<div class="achievement">${text}</div>`;
            }
        }

        function populateTitles() {
            if (userData[currentUser]?.isBanned) return;
            const select = document.getElementById("title-select");
            select.innerHTML = userData[currentUser].titles.map(title => 
                `<option value="${title}" ${userData[currentUser].activeTitle === title ? 'selected' : ''}>${title}</option>`
            ).join('');
        }

        function setTitle() {
            if (userData[currentUser]?.isBanned) return;
            const title = document.getElementById("title-select").value;
            userData[currentUser].activeTitle = title;
            localStorage.setItem('userData', JSON.stringify(userData));
            updateProfile(currentUser);
            alert(`Title set to "${title}"!`);
            playSound('click');
        }

        function replaceEmotes(text) {
            let result = text;
            for (let [shortcut, emoji] of Object.entries(emotes)) {
                result = result.replace(new RegExp(shortcut, 'g'), emoji);
            }
            return result;
        }

        function addEmote(inputId) {
            if (userData[currentUser]?.isBanned) return;
            const select = document.getElementById(`emote-select-${inputId.split('-')[1]}`);
            const emote = select.value;
            if (emote) {
                const input = document.getElementById(inputId);
                input.value += ` ${emote}`;
                select.value = "";
            }
        }

        function sendChat() {
            if (userData[currentUser]?.isBanned) {
                alert("You are banned and cannot chat!");
                return;
            }
            const message = document.getElementById("chat-input").value.trim();
            if (!message) return alert("Please enter a message.");
            if (!isLoggedIn) return alert("You must be logged in to chat.");
            const title = userData[currentUser].activeTitle || "Rookie";
            const chatMessage = `<p><b>${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
            document.getElementById("chat-box").innerHTML += chatMessage;
            chatHistory.push(chatMessage);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            document.getElementById("chat-input").value = "";
            playSound('click');
            document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
        }

        function loadChatHistory() {
            if (userData[currentUser]?.isBanned) {
                document.getElementById("chat-box").innerHTML = "<p>You are banned and cannot view chat.</p>";
                document.getElementById("chat-input").disabled = true;
                document.getElementById("emote-select-chat").disabled = true;
                document.getElementById("chat-input").placeholder = "Banned users cannot chat";
                return;
            }
            document.getElementById("chat-box").innerHTML = chatHistory.join('');
            document.getElementById("chat-input").disabled = false;
            document.getElementById("emote-select-chat").disabled = false;
            document.getElementById("chat-input").placeholder = "Type a message...";
        }

        function broadcastMessage() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const message = prompt("Enter broadcast message:").trim();
            if (!message) return;
            const title = userData[currentUser].activeTitle || "Rookie";
            const broadcast = `<p><b>[BROADCAST] ${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
            chatHistory.push(broadcast);
            document.getElementById("chat-box").innerHTML += broadcast;
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            alert("Message broadcasted!");
            playSound('fanfare');
        }

        function clearChat() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            if (confirm("Are you sure you want to clear the chat history?")) {
                chatHistory = [];
                document.getElementById("chat-box").innerHTML = "";
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                alert("Chat history cleared!");
                playSound('click');
            }
        }

        function updateMatchHistory(username) {
            if (userData[username]?.isBanned) return;
            const historyDiv = document.getElementById("history-list");
            historyDiv.innerHTML = userData[username].history.map(match => `<p>${match}</p>`).join('') || "<p>No matches yet.</p>";
        }

        function fetchRealStats() {
            if (userData[currentUser]?.isBanned) return;
            const simulatedStats = { kills: Math.floor(Math.random() * 50), deaths: Math.floor(Math.random() * 20) };
            userData[currentUser].kills = simulatedStats.kills;
            userData[currentUser].deaths = simulatedStats.deaths;
            localStorage.setItem('userData', JSON.stringify(userData));
            updateProfile(currentUser);
            playSound('fanfare');
            alert("Stats refreshed from game! (Simulated)");
        }

        function changePassword() {
            if (userData[currentUser]?.isBanned) return;
            if (!isLoggedIn) return alert("You must be logged in to change your password!");
            const currentPass = document.getElementById("current-password").value;
            const newPass = document.getElementById("new-password").value;
            if (!currentPass || !newPass) return alert("Please enter both current and new passwords.");
            if (userData[currentUser].password === currentPass) {
                if (newPass.length < 6) {
                    alert("New password must be at least 6 characters long!");
                    return;
                }
                userData[currentUser].password = newPass;
                localStorage.setItem('userData', JSON.stringify(userData));
                alert("Password changed successfully!");
                document.getElementById("current-password").value = "";
                document.getElementById("new-password").value = "";
                playSound('fanfare');
            } else {
                alert("Current password is incorrect!");
            }
        }

        function setBio() {
            if (userData[currentUser]?.isBanned) return;
            const bio = document.getElementById("bio-input").value.trim();
            if (bio.length > 50) return alert("Bio cannot exceed 50 characters!");
            userData[currentUser].bio = bio;
            localStorage.setItem('userData', JSON.stringify(userData));
            updateProfile(currentUser);
            alert("Bio updated!");
            playSound('click');
        }

        function checkDailyReward() {
            if (userData[currentUser]?.isBanned) return;
            const today = new Date().toDateString();
            if (userData[currentUser].lastLogin !== today) {
                userData[currentUser].kills += 5;
                userData[currentUser].lastLogin = today;
                localStorage.setItem('userData', JSON.stringify(userData));
                alert("Daily login reward: +5 kills!");
                playSound('fanfare');
                updateProfile(currentUser);
            }
        }

        function joinMatchmaking() {
            if (userData[currentUser]?.isBanned) return;
            if (!isLoggedIn) return alert("You must be logged in to join matchmaking!");
            if (matchmakingQueue.includes(currentUser)) {
                alert("You are already in the matchmaking queue!");
                return;
            }
            const team = assignTeam(currentUser);
            matchmakingQueue.push(currentUser);
            userData[currentUser].friends.forEach(f => {
                if (userData[f]) alert(`${userData[currentUser].activeTitle || "Rookie"} ${currentUser} joined matchmaking on ${team} team!`);
            });
            alert(`Added to matchmaking queue on ${team} team! Waiting for players...`);
            playSound('click');
            setTimeout(checkMatchmaking, 5000);
        }

        function checkMatchmaking() {
            if (userData[currentUser]?.isBanned) return;
            const totalPlayers = teams.red.length + teams.pink.length + teams.green.length;
            if (totalPlayers >= 18) {
                alert(`Match started! Teams - Red: ${teams.red.join(', ')}, Pink: ${teams.pink.join(', ')}, Green: ${teams.green.join(', ')}`);
                teams.red.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                teams.pink.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                teams.green.forEach(u => { if (Math.random() < 0.33) userData[u].wins += 1; });
                matchmakingQueue = [];
                for (let user in userData) userData[user].team = null;
                teams.red = []; teams.pink = []; teams.green = [];
                localStorage.setItem('userData', JSON.stringify(userData));
                playSound('fanfare');
                if (currentUser) updateProfile(currentUser);
            } else if (matchmakingQueue.length > 0) {
                setTimeout(checkMatchmaking, 5000);
            }
        }

        function addFriend() {
            if (userData[currentUser]?.isBanned) return;
            const friend = document.getElementById("friend-username").value.trim();
            if (!friend) return alert("Please enter a username.");
            if (friend === currentUser) return alert("You cannot add yourself!");
            if (userData[friend]) {
                if (!userData[currentUser].friends.includes(friend)) {
                    userData[currentUser].friends.push(friend);
                    localStorage.setItem('userData', JSON.stringify(userData));
                    updateFriendList();
                    alert(`${friend} added to your friends list!`);
                    playSound('click');
                } else {
                    alert("This user is already your friend!");
                }
            } else {
                alert("User not found!");
            }
        }

        function removeFriend(friend) {
            if (userData[currentUser]?.isBanned) return;
            if (confirm(`Are you sure you want to remove ${friend} from your friends list?`)) {
                userData[currentUser].friends = userData[currentUser].friends.filter(f => f !== friend);
                localStorage.setItem('userData', JSON.stringify(userData));
                updateFriendList();
                alert(`${friend} removed from your friends list!`);
                playSound('click');
                checkEmptyGroups();
            }
        }

        function inviteFriendToGroup(friend) {
            if (userData[currentUser]?.isBanned) return;
            const groupName = prompt(`Enter group chat name to invite ${friend} to:`).trim();
            if (!groupName || !groupChats[groupName]) {
                alert("Please enter a valid group chat name that exists!");
                return;
            }
            if (!groupChats[groupName].members.includes(currentUser)) {
                alert("You must be a member of the group to invite others!");
                return;
            }
            if (groupChats[groupName].members.includes(friend)) {
                alert(`${friend} is already in this group!`);
                return;
            }
            groupChats[groupName].members.push(friend);
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            alert(`${friend} invited to "${groupName}"!`);
            playSound('click');
        }

        function updateFriendList() {
            if (userData[currentUser]?.isBanned) return;
            const friendList = document.getElementById("friend-list");
            friendList.innerHTML = userData[currentUser].friends.map(f => {
                const status = Math.random() < 0.5 ? "Online" : "In-Game";
                const title = userData[f].activeTitle || "Rookie";
                const team = userData[f].team ? userData[f].team : "None";
                return `<p>${title} ${f} - ${status} (Team: ${team}) 
                    <button class="friend-button" onclick="inviteFriendToGroup('${f}')">Invite</button>
                    <button class="friend-button" onclick="removeFriend('${f}')">Remove</button></p>`;
            }).join('') || "<p>No friends yet.</p>";
        }

        function populateGroupMembers() {
            if (userData[currentUser]?.isBanned) return;
            const select = document.getElementById("group-members");
            select.innerHTML = userData[currentUser].friends.map(f => `<option value="${f}">${f}</option>`).join('') || "<option value=''>No friends to add</option>";
        }

        function createGroupChat() {
            if (userData[currentUser]?.isBanned) return;
            const groupName = document.getElementById("group-chat-name").value.trim();
            if (!groupName) return alert("Please enter a group name.");
            if (groupChats[groupName]) return alert("Group already exists!");
            const membersSelect = document.getElementById("group-members");
            const selectedMembers = Array.from(membersSelect.selectedOptions).map(option => option.value);
            if (selectedMembers.length === 0 || (selectedMembers.length === 1 && selectedMembers[0] === '')) {
                alert("You must add at least one friend to the group chat!");
                return;
            }
            groupChats[groupName] = {
                messages: [],
                members: [currentUser, ...selectedMembers]
            };
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            updateGroupChatSelect();
            document.getElementById("group-chat-select").value = groupName;
            switchGroupChat();
            alert(`Group "${groupName}" created with members: ${groupChats[groupName].members.join(', ')}!`);
            playSound('click');
            checkEmptyGroups();
        }

        function checkEmptyGroups() {
            if (userData[currentUser]?.isBanned) return;
            for (let groupName in groupChats) {
                const members = groupChats[groupName].members.filter(m => userData[m] && !userData[m].isBanned);
                if (members.length <= 1) {
                    delete groupChats[groupName];
                    alert(`Group "${groupName}" removed due to insufficient members!`);
                    playSound('click');
                }
            }
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            updateGroupChatSelect();
        }

        function updateGroupChatSelect() {
            if (userData[currentUser]?.isBanned) return;
            const select = document.getElementById("group-chat-select");
            select.innerHTML = "<option value=''>Select a group</option>" + Object.keys(groupChats).map(name => `<option value="${name}">${name}</option>`).join('');
        }

        function switchGroupChat() {
            if (userData[currentUser]?.isBanned) return;
            const groupName = document.getElementById("group-chat-select").value;
            if (groupName && groupChats[groupName]) {
                document.getElementById("group-chat-box").innerHTML = groupChats[groupName].messages.join('');
            } else {
                document.getElementById("group-chat-box").innerHTML = "<p>Select a group to chat.</p>";
            }
        }

        function sendGroupChat() {
            if (userData[currentUser]?.isBanned) return;
            const groupName = document.getElementById("group-chat-select").value;
            const message = document.getElementById("group-chat-input").value.trim();
            if (!groupName) return alert("Please select a group.");
            if (!message) return alert("Please enter a message.");
            if (!groupChats[groupName].members.includes(currentUser)) return alert("You are not a member of this group!");
            const title = userData[currentUser].activeTitle || "Rookie";
            const groupMessage = `<p><b>${title} ${currentUser}:</b> ${replaceEmotes(message)}</p>`;
            groupChats[groupName].messages.push(groupMessage);
            localStorage.setItem('groupChats', JSON.stringify(groupChats));
            document.getElementById("group-chat-box").innerHTML += groupMessage;
            document.getElementById("group-chat-input").value = "";
            playSound('click');
            document.getElementById("group-chat-box").scrollTop = document.getElementById("group-chat-box").scrollHeight;
        }

        function sendPrivateMessage() {
            if (userData[currentUser]?.isBanned) return;
            const recipient = document.getElementById("message-recipient").value.trim();
            const message = document.getElementById("message-input").value.trim();
            if (!recipient || !message) return alert("Please enter a recipient and message.");
            if (userData[recipient]) {
                const title = userData[currentUser].activeTitle || "Rookie";
                const msg = { from: currentUser, text: replaceEmotes(message), time: new Date().toLocaleString(), title: title };
                userData[recipient].messages.push(msg);
                userData[currentUser].messages.push(msg);
                localStorage.setItem('userData', JSON.stringify(userData));
                document.getElementById("message-input").value = "";
                updateMessages();
                alert(`Message sent to ${recipient}!`);
                playSound('click');
            } else {
                alert("Recipient not found!");
            }
        }

        function updateMessages() {
            if (userData[currentUser]?.isBanned) return;
            const messageBox = document.getElementById("message-box");
            messageBox.innerHTML = userData[currentUser].messages.map(m => 
                `<p><b>${m.title} ${m.from}:</b> ${m.text} (${m.time})</p>`
            ).join('') || "<p>No messages yet.</p>";
        }

        function banUser() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const target = document.getElementById("admin-target").value.trim();
            const reason = document.getElementById("ban-reason").value.trim();
            if (!target) return alert("Please enter a username to ban.");
            if (target === currentUser) return alert("You cannot ban yourself!");
            if (userData[target]) {
                if (userData[target].isOwner) return alert("You cannot ban the owner!");
                userData[target].isBanned = true;
                userData[target].banReason = reason || "No reason provided";
                if (userData[target].team) teams[userData[target].team] = teams[userData[target].team].filter(u => u !== target);
                userData[target].team = null;
                localStorage.setItem('userData', JSON.stringify(userData));
                alert(`${target} has been banned! Reason: ${userData[target].banReason}`);
                playSound('click');
                updateLeaderboard();
                checkEmptyGroups();
                if (target === currentUser) showBannedNotice();
            } else {
                alert("User not found!");
            }
        }

        function unbanUser() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const target = document.getElementById("admin-target").value.trim();
            if (!target) return alert("Please enter a username to unban.");
            if (userData[target]) {
                userData[target].isBanned = false;
                userData[target].banReason = '';
                localStorage.setItem('userData', JSON.stringify(userData));
                alert(`${target} has been unbanned!`);
                playSound('click');
                updateLeaderboard();
            } else {
                alert("User not found!");
            }
        }

        function makeAdmin() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const target = document.getElementById("admin-target").value.trim();
            if (!target) return alert("Please enter a username.");
            if (target === currentUser) return alert("You are already an admin!");
            if (userData[target]) {
                userData[target].isAdmin = true;
                localStorage.setItem('userData', JSON.stringify(userData));
                alert(`${target} is now an admin!`);
                playSound('fanfare');
            } else {
                alert("User not found!");
            }
        }

        function removeAdmin() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const target = document.getElementById("admin-target").value.trim();
            if (!target) return alert("Please enter a username.");
            if (target === currentUser) return alert("You cannot remove your own admin status!");
            if (target === 'Halaldeveloper') return alert("You cannot remove the owner's admin status!");
            if (userData[target]) {
                userData[target].isAdmin = false;
                localStorage.setItem('userData', JSON.stringify(userData));
                alert(`${target} is no longer an admin!`);
                playSound('click');
            } else {
                alert("User not found!");
            }
        }

        function resetUserStats() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const target = document.getElementById("admin-target").value.trim();
            if (!target) return alert("Please enter a username.");
            if (userData[target]) {
                userData[target].kills = 0;
                userData[target].deaths = 0;
                userData[target].gamesPlayed = 0;
                userData[target].wins = 0;
                userData[target].history = [];
                userData[target].titles = ["Rookie"];
                userData[target].activeTitle = "Rookie";
                localStorage.setItem('userData', JSON.stringify(userData));
                alert(`${target}'s stats have been reset!`);
                playSound('click');
                if (target === currentUser) updateProfile(currentUser);
            } else {
                alert("User not found!");
            }
        }

        function massBan() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const targets = prompt("Enter usernames to ban (comma-separated):")?.trim();
            const reason = document.getElementById("ban-reason").value.trim();
            if (!targets) return alert("Please enter at least one username.");
            const userList = targets.split(',').map(t => t.trim());
            let banned = [];
            userList.forEach(target => {
                if (userData[target] && target !== currentUser && !userData[target].isOwner) {
                    userData[target].isBanned = true;
                    userData[target].banReason = reason || "Mass ban - no reason provided";
                    if (userData[target].team) teams[userData[target].team] = teams[userData[target].team].filter(u => u !== target);
                    userData[target].team = null;
                    banned.push(target);
                }
            });
            localStorage.setItem('userData', JSON.stringify(userData));
            alert(`Banned: ${banned.join(', ') || 'None'}`);
            playSound('click');
            updateLeaderboard();
            checkEmptyGroups();
            if (banned.includes(currentUser)) showBannedNotice();
        }

        function massUnban() {
            if (userData[currentUser]?.isBanned || !userData[currentUser]?.isAdmin) return alert("You are not an admin or are banned!");
            const targets = prompt("Enter usernames to unban (comma-separated):")?.trim();
            if (!targets) return alert("Please enter at least one username.");
            const userList = targets.split(',').map(t => t.trim());
            let unbanned = [];
            userList.forEach(target => {
                if (userData[target]) {
                    userData[target].isBanned = false;
                    userData[target].banReason = '';
                    unbanned.push(target);
                }
            });
            localStorage.setItem('userData', JSON.stringify(userData));
            alert(`Unbanned: ${unbanned.join(', ') || 'None'}`);
            playSound('click');
            updateLeaderboard();
        }

        function exportData() {
            if (userData[currentUser]?.isBanned) return;
            const data = {
                userData: userData,
                chatHistory: chatHistory,
                groupChats: groupChats,
                soundSettings: soundSettings,
                teams: teams
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "laser_tag_data.json";
            a.click();
            URL.revokeObjectURL(url);
            alert("Data exported! Save this file to import later.");
            playSound('click');
        }
    </script>
</body>
</html>
